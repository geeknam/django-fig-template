db:
  build: Dockerfiles/postgres
  environment:
    - POSTGRES_USER=postgres
    - POSTGRES_PASSWORD=postgres

cache:
  image: redis

broker:
  image: tutum/rabbitmq
  environment:
    - RABBITMQ_USER=app
    - RABBITMQ_PASS=app

web:
  build: Dockerfiles/nginx
  working_dir: /etc/nginx
  ports:
    - "80:80"
  links:
    - app

app:
  build: .
  working_dir: /code/app
  command: gunicorn app.wsgi:application -b 0.0.0.0:8000 -w 4
  environment:
    - DJANGO_CONFIGURATION=Local
    - DJANGO_SETTINGS_MODULE=app.settings
    - DATABASE_HOST=db
    - DATABASE_NAME=postgres
    - DATABASE_PASSWORD=postgres
    - STATIC_ROOT=Dockerfiles/nginx/static_assets/static
    - BROKER_URL=amqp://app:app@broker:5672//
    - REDIS_CACHE_URL=cache:6379:1
  volumes:
    - .:/code
  links:
    - db
    - cache
    - broker

worker:
  build: .
  working_dir: /code/app
  command: celery -A app worker -l info
  environment:
    - DJANGO_CONFIGURATION=Local
    - DJANGO_SETTINGS_MODULE=app.settings
    - DATABASE_HOST=db
    - DATABASE_NAME=postgres
    - DATABASE_PASSWORD=postgres
    - STATIC_ROOT=Dockerfiles/nginx/static_assets/static
    - BROKER_URL=amqp://app:app@broker:5672//
    - REDIS_CACHE_URL=cache:6379:1
    - C_FORCE_ROOT=true # Don't do this in prod
  volumes:
    - .:/code
  links:
    - db
    - cache
    - broker